#ifdef GL_ES
precision mediump float;
#endif

uniform float time;
uniform vec2 resolution;
// https://www.shadertoy.com/view/XslSRs
// By David Hoskins.

// Sharbat Gula. Iconic image from 1984.
// http://en.wikipedia.org/wiki/Afghan_Girl
// Genetic algorithm. Over 1300000 random generations with 64000 chosen iterations
// to home in on the original image.
// Overlapping transparencies of 256 triangles with moving dither.

// Yay Chrome 36!!!! We can do it now! :)

// Add noise to the triangles to make it a little clearer...
#define ADD_DITHER

vec3 col = vec3(0.0);
vec2 uv = vec2(0.0);
const vec2 INV_SCALE  = 1.0 / vec2(511.0, 511.0*410.0/800.0);

//========================================================================
#ifdef ADD_DITHER
vec2 Hash2( vec2 x )
{
	float n = dot(x,vec2(1.0,113.00)) + time;
    return fract(sin(vec2(n,n+.321))*vec2(3758.5233,2578.1459));
}
#endif

//========================================================================
vec2 unpackCoord(float f) 
{
    vec2 coord;
    coord.x = floor(mod(f, 512.0));
    coord.y = floor(f / 512.0)-224.7;
    return coord * INV_SCALE;
}

//========================================================================
vec2 unpackColour(float f) 
{
    vec2 colour;
    colour.x = floor(mod (f, 256.0));
    colour.y = floor(f / 256.0);
    return colour / 255.0;
}

//========================================================================
void Tri(float pA, float pB, float pC, float pCol1, float pCol2)
{
	vec2 pos = uv;
	vec2 a = unpackCoord(pA);
	vec2 b = unpackCoord(pB);
	vec2 c = unpackCoord(pC);
#ifdef ADD_DITHER
	vec2 randValues = vec2(0.01, 0.005) * (1.0+smoothstep(3.0, 0.0, (time+5.)*.5)*20.0);
	pos += Hash2(gl_FragCoord.xy) * randValues.x - randValues.y;
	pos = clamp(pos, vec2(0.0004), vec2(.996));
#endif

	// This is the smallest 2D triangle test I could find...
	float as_x = pos.x-a.x;
    float as_y = pos.y-a.y;
	bool si = (b.x-a.x)*as_y-(b.y-a.y)*as_x > 0.0;
    if ((c.x-a.x)*as_y-(c.y-a.y)*as_x > 0.0 == si) return;
    if ((c.x-b.x)*(pos.y-b.y)-(c.y-b.y)*(pos.x-b.x) > 0.0 != si) return;
	// ...done triangle test! :)
	
	vec2 c1 = unpackColour(pCol1);
	vec2 c2 = unpackColour(pCol2);
	vec4 triCol = vec4(c1, c2);
	col = mix (col, triCol.rgb, triCol.a); 
}

//========================================================================
void main(void)
{
	uv = gl_FragCoord.xy / resolution.xy;
	
	// Data parameters:
	// Tri( X1/Y1, X2/Y2, X3/y3, RG, BA)
	
	Tri(138690., 209341.,139195., 49878., 12444.);
	Tri(191359., 145168.,146248., 64508., 15285.);
	Tri(179763., 202617.,125756., 6177., 12319.);
	Tri(143872., 167428.,114911., 13265., 7723.);
	Tri(135442., 114994.,236380., 42712., 12693.);
	Tri(150754., 216254.,154355., 42192., 12656.);
	Tri(115233., 115006.,203478., 10921., 10801.);
	Tri(156923., 154828.,223093., 50936., 11349.);
	Tri(178493., 156987.,202107., 64761., 14838.);
	Tri(140595., 183448.,195975., 17556., 10042.);
	Tri(260517., 185273.,199119., 59583., 15281.);
	Tri(205476., 135519.,199565., 31188., 10039.);
	Tri(174454., 198013.,192392., 40898., 14731.);
	Tri(124624., 159779.,139969., 11946., 12101.);
	Tri(190528., 138923.,207504., 16128., 11808.);
	Tri(192844., 226775.,227288., 34770., 10628.);
	Tri(192153., 188023.,213638., 6509., 10252.);
	Tri(168887., 115634.,168393., 65022., 15357.);
	Tri(158141., 115199.,164809., 47459., 14240.);
	Tri(146037., 132148.,115319., 18007., 8777.);
	Tri(207735., 209271.,150395., 60385., 14834.);
	Tri(254390., 195382.,259857., 16476., 9532.);
	Tri(217651., 130634.,153088., 2147., 14339.);
	Tri(212308., 161279.,191373., 2305., 11026.);
	Tri(261727., 203306.,261739., 954., 9219.);
	Tri(170426., 159178.,216002., 54266., 15269.);
	Tri(136512., 148673.,129343., 22945., 14481.);
	Tri(156421., 172816.,209807., 4354., 14851.);
	Tri(118826., 114728.,114739., 24531., 10873.);
	Tri(188347., 210433.,195330., 42702., 3561.);
	Tri(176843., 168677.,179447., 46839., 11949.);
	Tri(146176., 152351.,205525., 47102., 15010.);
	Tri(188214., 193393.,196984., 63229., 15354.);
	Tri(130706., 144956.,128636., 16722., 14422.);
	Tri(213690., 215818.,203951., 30957., 14129.);
	Tri(193939., 207083.,197858., 44649., 11633.);
	Tri(257769., 234368.,245480., 16480., 9540.);
	Tri(252651., 251368.,252658., 37266., 12404.);
	Tri(152946., 186252.,132439., 63998., 15340.);
	Tri(131803., 149329.,151375., 51688., 9966.);
	Tri(202400., 247357.,146555., 16966., 15152.);
	Tri(198734., 234389.,234904., 27007., 9109.);
	Tri(133364., 131336.,245008., 63740., 11907.);
	Tri(168310., 194871.,150895., 41905., 15188.);
	Tri(207421., 155648.,179727., 25171., 13103.);
	Tri(195847., 221442.,173343., 63730., 15089.);
	Tri(174921., 178492.,130892., 61395., 14060.);
	Tri(210828., 152249.,196989., 60151., 8616.);
	Tri(137496., 124660.,117499., 52165., 10381.);
	Tri(183581., 152703.,221527., 2576., 15112.);
	Tri(234269., 199563.,252704., 30393., 13182.);
	Tri(135811., 140988.,114914., 33259., 14455.);
	Tri(139848., 187017.,152864., 1551., 14085.);
	Tri(134570., 133039.,132018., 41706., 10009.);
	Tri(193199., 230670.,180903., 24256., 9034.);
	Tri(204098., 132913.,138078., 58869., 15279.);
	Tri(117308., 218881.,118335., 32543., 9969.);
	Tri(201658., 161369.,191428., 3369., 11033.);
	Tri(191283., 247112.,219521., 52989., 15230.);
	Tri(164164., 241516.,157849., 31982., 7993.);
	Tri(212840., 242501.,246104., 48360., 9603.);
	Tri(210603., 139003.,221395., 18582., 12857.);
	Tri(239635., 260980.,239635., 34932., 10009.);
	Tri(199206., 132062.,133606., 3329., 8217.);
	Tri(189271., 122452.,188243., 65269., 14578.);
	Tri(241734., 242409.,241737., 29289., 8815.);
	Tri(139988., 234269.,142592., 61436., 5333.);
	Tri(138051., 157445.,163615., 54526., 14266.);
	Tri(258309., 247619.,143090., 56564., 7854.);
	Tri(148534., 157747.,133368., 13470., 9517.);
	Tri(233303., 211816.,210744., 64504., 15270.);
	Tri(229362., 228847.,177861., 32442., 14328.);
	Tri(147401., 115113.,115151., 509., 11529.);
	Tri(168349., 184228.,145339., 1931., 10787.);
	Tri(236754., 138957.,152754., 47051., 4424.);
	Tri(204094., 202055.,133962., 65278., 15050.);
	Tri(257000., 256162.,256167., 56572., 9214.);
	Tri(185054., 197300.,215262., 63738., 2781.);
	Tri(164870., 197668.,192558., 64568., 15214.);
	Tri(182599., 200007.,167219., 47598., 14750.);
	Tri(137503., 182137.,137001., 62716., 9948.);
	Tri(200133., 154571.,115117., 28639., 13915.);
	Tri(190283., 213900.,188221., 9509., 14891.);
	Tri(262028., 262143.,168390., 50160., 9541.);
	Tri(160416., 169141.,189592., 28158., 4145.);
	Tri(240724., 191173.,230763., 256., 14592.);
	Tri(130902., 186765.,188730., 59646., 15291.);
	Tri(115004., 115486.,145770., 48850., 12729.);
	Tri(214512., 215025.,129200., 1546., 15114.);
	Tri(262051., 247227.,168353., 5775., 13070.);
	Tri(114936., 115004.,206200., 58622., 14999.);
	Tri(246088., 222527.,203967., 35791., 8868.);
	Tri(117759., 156655.,246687., 45351., 10585.);
	Tri(156309., 133470.,162015., 3155., 14855.);
	Tri(194443., 149359.,136831., 41186., 12376.);
	Tri(196796., 196794.,230311., 35466., 14205.);
	Tri(116506., 123621.,165078., 16987., 14362.);
	Tri(166829., 148387.,187342., 16764., 15176.);
	Tri(131071., 188848.,115198., 54098., 14270.);
	Tri(224948., 164634.,229566., 546., 10761.);
	Tri(178157., 189412.,194528., 59306., 10171.);
	Tri(262143., 207871.,198104., 29606., 15165.);
	Tri(156319., 148644.,168439., 3357., 10499.);
	Tri(234325., 220881.,210683., 16232., 15160.);
	Tri(134958., 141105.,216263., 5198., 15117.);
	Tri(175147., 261632.,163328., 22123., 9544.);
	Tri(115574., 160283.,124282., 1329., 15109.);
	Tri(114955., 115518.,183161., 55805., 14997.);
	Tri(146715., 138088.,146045., 291., 12049.);
	Tri(125346., 178091.,168881., 40620., 13213.);
	Tri(216447., 180386.,178352., 2365., 15105.);
	Tri(198091., 262012.,262062., 37118., 15232.);
	Tri(154484., 176005.,153947., 42705., 12696.);
	Tri(150456., 177026.,156587., 57554., 13497.);
	Tri(201456., 198908.,207604., 64969., 15243.);
	Tri(198963., 169846.,232208., 43160., 13451.);
	Tri(155214., 149095.,153658., 20725., 15164.);
	Tri(131852., 132976.,125302., 5673., 14367.);
	Tri(158023., 246767.,210932., 10561., 10008.);
	Tri(182072., 160572.,196270., 33973., 12893.);
	Tri(261944., 261966.,207420., 13382., 7731.);
	Tri(186545., 127788.,220350., 29841., 13383.);
	Tri(202703., 168863.,127991., 2598., 14602.);
	Tri(152062., 210431.,199132., 14633., 10254.);
	Tri(246622., 184062.,177929., 22128., 8555.);
	Tri(249404., 114831.,115200., 17559., 9511.);
	Tri(146248., 158013.,141546., 65268., 14521.);
	Tri(207755., 215335.,249668., 51965., 14241.);
	Tri(181490., 199354.,188166., 57844., 11713.);
	Tri(168325., 188557.,255822., 43254., 7812.);
	Tri(226903., 261633.,240646., 3883., 13847.);
	Tri(145490., 141069.,117570., 58297., 2973.);
	Tri(233391., 209327.,229288., 16409., 12049.);
	Tri(165247., 117569.,216883., 53245., 14236.);
	Tri(210695., 196867.,197399., 65277., 15358.);
	Tri(115146., 223171.,115711., 45312., 15188.);
	Tri(204238., 262060.,172989., 1422., 13843.);
	Tri(249404., 222255.,253995., 18765., 8725.);
	Tri(179145., 197038.,192454., 51454., 13736.);
	Tri(207871., 115710.,114825., 30172., 7782.);
	Tri(197510., 127314.,147746., 49132., 12936.);
	Tri(129658., 144919.,141650., 12636., 14866.);
	Tri(168804., 180394.,165032., 6472., 9246.);
	Tri(129802., 220912.,225522., 37746., 9034.);
	Tri(218935., 234833.,152899., 59901., 14506.);
	Tri(204168., 236905.,228042., 64246., 3561.);
	Tri(261632., 261732.,183813., 14131., 8213.);
	Tri(114839., 114778.,121445., 22954., 12387.);
	Tri(178371., 210189.,115446., 50640., 8347.);
	Tri(207040., 200892.,194771., 49125., 12878.);
	Tri(163595., 204595.,139043., 1053., 15105.);
	Tri(134138., 185268.,236469., 63918., 4092.);
	Tri(192888., 201054.,202613., 65277., 15355.);
	Tri(125619., 116366.,135809., 37874., 7818.);
	Tri(167487., 159299.,155222., 31696., 12705.);
	Tri(243862., 192309.,245489., 262., 15110.);
	Tri(226792., 234342.,218797., 10319., 8464.);
	Tri(212082., 212082.,148847., 21095., 8961.);
	Tri(115573., 240061.,115152., 471., 7681.);
	Tri(218839., 211853.,244973., 51454., 13179.);
	Tri(185428., 261907.,146052., 788., 15114.);
	Tri(114857., 163416.,121344., 14735., 10052.);
	Tri(115199., 150472.,115109., 65195., 9952.);
	Tri(250119., 257848.,148334., 49396., 10381.);
	Tri(204148., 191859.,203610., 65018., 15357.);
	Tri(156672., 134029.,170596., 777., 12804.);
	Tri(208218., 239940.,212830., 14926., 8016.);
	Tri(167424., 114688.,181903., 2606., 14860.);
	Tri(206888., 193088.,237661., 114., 9245.);
	Tri(216364., 202529.,212349., 24216., 11319.);
	Tri(178632., 174525.,218542., 45054., 9352.);
	Tri(160045., 145129.,217409., 1046., 14081.);
	Tri(148239., 210706.,155330., 64507., 5118.);
	Tri(202636., 166784.,175964., 21663., 8825.);
	Tri(233998., 233998.,141516., 18408., 14412.);
	Tri(209561., 206149.,219901., 263., 15105.);
	Tri(239542., 193281.,231832., 34683., 13993.);
	Tri(162241., 194485.,197050., 65278., 15326.);
	Tri(204097., 186092.,196416., 19830., 13096.);
	Tri(159405., 136915.,158921., 11903., 14643.);
	Tri(201880., 117516.,208536., 10077., 11545.);
	Tri(253025., 168618.,168618., 58826., 11693.);
	Tri(173446., 222482.,241505., 56292., 7871.);
	Tri(128923., 237861.,243007., 4890., 7702.);
	Tri(190746., 190746.,141722., 24137., 12062.);
	Tri(248301., 225843.,248301., 64111., 10532.);
	Tri(248228., 209258.,138691., 2., 15106.);
	Tri(194411., 206703.,209763., 512., 15106.);
	Tri(132303., 223820.,223820., 40164., 10532.);
	Tri(251468., 170010.,250415., 8194., 13591.);
	Tri(217635., 258242.,217637., 18372., 9752.);
	Tri(214405., 206146.,251688., 55294., 13459.);
	Tri(165342., 123277.,124303., 56836., 8369.);
	Tri(148655., 114965.,139042., 19033., 15152.);
	Tri(203702., 245165.,259460., 7780., 14882.);
	Tri(205164., 156022.,190858., 59646., 10668.);
	Tri(224153., 253307.,236917., 28279., 11889.);
	Tri(125454., 124467.,119338., 12449., 13359.);
	Tri(210746., 206602.,224443., 258., 15106.);
	Tri(170561., 170561.,150411., 31432., 13271.);
	Tri(172052., 132820.,224943., 2054., 14855.);
	Tri(223811., 139462.,150606., 7170., 15127.);
	Tri(227311., 115105.,230345., 1538., 12033.);
	Tri(261729., 261632.,158720., 65171., 12151.);
	Tri(261745., 242757.,133632., 60., 15106.);
	Tri(144744., 155508.,168216., 31647., 15189.);
	Tri(115711., 262142.,230335., 62546., 3049.);
	Tri(173956., 160563.,187239., 44259., 15248.);
	Tri(213430., 253653.,241885., 4637., 7686.);
	Tri(128206., 114875.,114915., 28597., 10851.);
	Tri(114963., 209604.,126801., 47867., 10652.);
	Tri(205162., 192881.,201592., 65278., 15358.);
	Tri(177825., 178176.,177669., 32948., 8944.);
	Tri(154122., 169539.,178757., 3673., 14857.);
	Tri(195927., 185712.,202586., 27469., 15155.);
	Tri(123743., 138893.,126424., 4143., 10250.);
	Tri(261657., 160274.,231005., 7467., 10767.);
	Tri(157006., 189678.,176858., 40698., 8080.);
	Tri(153088., 125440.,123490., 14249., 15153.);
	Tri(262052., 262143.,127487., 64090., 15007.);
	Tri(261962., 223559.,239362., 15192., 13355.);
	Tri(161776., 185233.,185233., 19255., 11976.);
	Tri(246005., 253755.,203660., 51187., 11674.);
	Tri(128081., 254491.,125523., 21883., 10828.);
	Tri(115134., 151471.,146889., 19., 14850.);
	Tri(242404., 224480.,218316., 13730., 8489.);
	Tri(137936., 159744.,258136., 519., 15106.);
	Tri(258816., 230702.,211629., 6206., 15134.);
	Tri(248304., 185406.,185406., 52538., 10089.);
	Tri(152938., 152426.,159068., 62440., 8620.);
	Tri(127040., 140322.,147443., 3379., 8225.);
	Tri(224492., 241401.,215324., 36859., 9552.);
	Tri(178287., 163767.,178287., 50261., 11530.);
	Tri(197156., 192561.,216627., 41255., 15187.);
	Tri(205014., 131842.,169678., 26509., 15178.);
	Tri(167138., 167184.,202017., 47588., 12697.);
	Tri(244469., 190782.,234870., 42480., 11601.);
	Tri(242527., 219526.,188808., 15479., 13869.);
	Tri(150084., 141210.,137793., 38., 10497.);
	Tri(260910., 154788.,245425., 6964., 14862.);
	Tri(157734., 125952.,149126., 5963., 13337.);
	Tri(207554., 180420.,173348., 37323., 11634.);
	Tri(244469., 222985.,233864., 1280., 2853.);
	Tri(258332., 252208.,246554., 21332., 12107.);
	Tri(133410., 140110.,139552., 48891., 15297.);
	Tri(141517., 132952.,140616., 41937., 8363.);
	Tri(261662., 134964.,262135., 23934., 7758.);
	Tri(230819., 210393.,189909., 12036., 8475.);
	Tri(114688., 115740.,126464., 1160., 12052.);
	Tri(170286., 221569.,221569., 4138., 8744.);
	Tri(133190., 147538.,140485., 11117., 14395.);
	Tri(192266., 205583.,208118., 65277., 15358.);
	Tri(125752., 141137.,123718., 17729., 15157.);
	Tri(134298., 216979.,216465., 57338., 8110.);
	Tri(190872., 154002.,157587., 17456., 11142.);
	Tri(157506., 236748.,146087., 12367., 13859.);

	gl_FragColor = vec4(min(col*1.35, 1.0), 1.0 );
}
